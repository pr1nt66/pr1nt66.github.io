<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cifrador Multicapa</title>
  <style>
    :root {
      --primary: #2647d8;
      --primary-hover: #4f46e5;
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #f1f5f9;
      --accent: #2647d8;
    }

    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: var(--bg); 
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 800px;
      width: 100%;
    }

    h1 { text-align: center; color: var(--primary); font-weight: 800; letter-spacing: -1px; }
    
    .card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    h3 { margin-top: 0; color: var(--accent); font-size: 1.2rem; }

    label { display: block; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.8; }

    textarea, input[type="password"] { 
      width: 100%; 
      padding: 12px; 
      border-radius: 8px; 
      border: 1px solid #334155; 
      background: #0f172a; 
      color: white; 
      box-sizing: border-box;
      margin-bottom: 15px;
      font-family: inherit;
      transition: border 0.3s;
    }

    textarea:focus, input:focus { border-color: var(--primary); outline: none; }

    .actions { display: flex; gap: 10px; }

    button { 
      flex: 1;
      padding: 12px; 
      background: var(--primary); 
      border: 0; 
      color: white; 
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer; 
      transition: transform 0.1s, background 0.2s;
    }

    button:hover { background: var(--primary-hover); }
    button:active { transform: scale(0.98); }
    
    button.secondary { background: #475569; }

    .output-container { position: relative; }

    .output { 
      background: #000000; 
      padding: 20px; 
      border-radius: 8px; 
      border: 1px solid var(--primary); 
      min-height: 60px;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: #10b981;
      white-space: pre-wrap;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      font-size: 0.7rem;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid var(--primary);
      width: auto;
      flex: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>CIFRADOR MULTICAPA</h1>
    
    <div class="card">
      <h3> Cifrar Mensaje</h3>
      <label>Mensaje original:</label>
      <textarea id="mensaje" placeholder="Escribe tu mensaje secreto aquí..."></textarea>
      
      <label>Contraseña de cifrado:</label>
      <input type="password" id="password" placeholder="Usa una clave fuerte">
      
      <button onclick="cifrar()">Generar Cifrado</button>
    </div>

    <div class="card">
      <h3> Descifrar Mensaje</h3>
      <label>Código JSON cifrado:</label>
      <textarea id="mensajeCifrado" placeholder='Ejemplo: {"salt":"...","iv":"...","datos":"..."}'></textarea>
      
      <label>Contraseña de descifrado:</label>
      <input type="password" id="passwordDescifrar" placeholder="Introduce la clave">
      
      <button onclick="descifrar()" class="secondary">Descifrar</button>
    </div>

    <div class="card">
      <h3> Resultado</h3>
      <div class="output-container">
        <button class="copy-btn" onclick="copiarAlPortapapeles()">Copiar</button>
        <div class="output" id="resultado">Los resultados aparecerán aquí...</div>
      </div>
    </div>
  </div>

  <script>
    function arrayToBase64(array) {
      return btoa(String.fromCharCode.apply(null, array));
    }

    function base64ToArray(base64) {
      return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    }

    function xor(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = data[i] ^ key[i % key.length];
      }
      return out;
    }

    function sustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] + key[i % key.length]) % 256;
      }
      return out;
    }

    function inversaSustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] - key[i % key.length] + 256) % 256;
      }
      return out;
    }

    async function derivarClave(password, salt, length=32) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveBits"]
      );
      const bits = await crypto.subtle.deriveBits(
        {name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"},
        keyMaterial, length*8
      );
      return new Uint8Array(bits);
    }

    async function cifrarAES(data, key) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["encrypt"]);
      const cifrado = await crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, cryptoKey, data);
      return {iv: iv, datos: new Uint8Array(cifrado)};
    }

    async function descifrarAES(datos, key, iv) {
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["decrypt"]);
      const descifrado = await crypto.subtle.decrypt({name: "AES-GCM", iv: iv}, cryptoKey, datos);
      return new Uint8Array(descifrado);
    }

    async function cifrar() {
      try {
        const mensaje = document.getElementById("mensaje").value;
        const password = document.getElementById("password").value;
        if (!mensaje || !password) { alert("Rellena todos los campos"); return; }

        const enc = new TextEncoder();
        let datos = enc.encode(mensaje);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const clave = await derivarClave(password, salt, 32);

        datos = xor(datos, clave);
        datos = sustitucion(datos, clave);
        const aes = await cifrarAES(datos, clave);
        
        const resultado = {
          salt: arrayToBase64(salt),
          iv: arrayToBase64(aes.iv),
          datos: arrayToBase64(aes.datos)
        };

        document.getElementById("resultado").innerText = JSON.stringify(resultado, null, 2);
      } catch (error) {
        document.getElementById("resultado").innerText = "Error: " + error.message;
      }
    }

    async function descifrar() {
      try {
        const password = document.getElementById("passwordDescifrar").value;
        let input = document.getElementById("mensajeCifrado").value.trim();
        if (!password || !input) { alert("Ingresa clave y mensaje cifrado"); return; }

        const paquete = JSON.parse(input);
        const salt = base64ToArray(paquete.salt);
        const iv = base64ToArray(paquete.iv);
        const datos = base64ToArray(paquete.datos);

        const clave = await derivarClave(password, salt, 32);
        let descifrado = await descifrarAES(datos, clave, iv);
        descifrado = inversaSustitucion(descifrado, clave);
        descifrado = xor(descifrado, clave);

        document.getElementById("resultado").innerText = new TextDecoder().decode(descifrado);
      } catch (error) {
        document.getElementById("resultado").innerText = "Error: Contraseña incorrecta o formato inválido";
      }
    }

    function copiarAlPortapapeles() {
      const texto = document.getElementById("resultado").innerText;
      navigator.clipboard.writeText(texto);
      const btn = document.querySelector('.copy-btn');
      btn.innerText = "¡Copiado!";
      setTimeout(() => btn.innerText = "Copiar", 2000);
    }
  </script>
</body>
</html>
