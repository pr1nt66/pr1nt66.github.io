<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cifrador</title>
  <style>
    body {  margin: 20px; background: #adcfcf; }
    h1 { text-align: center; }
    h3 { margin-top: 20px; color: #333; }
    hr { margin: 30px 0; border: 1px solid #999; }
    textarea { width: 100%; height: 70px; border: 1px solid #000000 }
    .output { background: #f7f7f7; padding: 30px; border: 1px solid #000000; margin-top: 10px; word-wrap: break-word}
    button { margin: 5px; padding: 10px 50px; background: #7a7272; border: 0px; color: white; cursor: pointer; }
    button:hover { background: #5a5252; }
    input[type="password"] { padding: 5px; width: 300px; }
  </style>
</head>

<body>
  <h1>CIFRADOR MULTICAPA</h1>
  
  <h3>Para Cifrar:</h3>
  <label>Mensaje a cifrar:</label><br>
  <textarea id="mensaje" placeholder="Escribe aquí tu mensaje"></textarea><br>
  
  <label>Contraseña:</label><br>
  <input type="password" id="password"><br><br>
  
  <button onclick="cifrar()">Cifrar</button>
  
  <hr>
  
  <h3>Para Descifrar:</h3>
  <label>Mensaje cifrado (pega el JSON aquí):</label><br>
  <textarea id="mensajeCifrado" placeholder='{"salt":"...","iv":"...","datos":"..."}'></textarea><br>
  
  <label>Contraseña:</label><br>
  <input type="password" id="passwordDescifrar"><br><br>
  
  <button onclick="descifrar()">Descifrar</button>
  
  <hr>
  
  <h3>Resultado:</h3>
  <div class="output" id="resultado">Aquí aparecerá el resultado</div>
  
  <script>
    function arrayToBase64(array) {
      return btoa(String.fromCharCode.apply(null, array));
    }

    function base64ToArray(base64) {
      return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    }

    function xor(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = data[i] ^ key[i % key.length];
      }
      return out;
    }

    function sustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] + key[i % key.length]) % 256;
      }
      return out;
    }

    function inversaSustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] - key[i % key.length] + 256) % 256;
      }
      return out;
    }

    async function derivarClave(password, salt, length=32) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveBits"]
      );
      const bits = await crypto.subtle.deriveBits(
        {name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"},
        keyMaterial, length*8
      );
      return new Uint8Array(bits);
    }

    async function cifrarAES(data, key) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["encrypt"]);
      const cifrado = await crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, cryptoKey, data);
      return {iv: iv, datos: new Uint8Array(cifrado)};
    }

    async function descifrarAES(datos, key, iv) {
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["decrypt"]);
      const descifrado = await crypto.subtle.decrypt({name: "AES-GCM", iv: iv}, cryptoKey, datos);
      return new Uint8Array(descifrado);
    }

    async function cifrar() {
      try {
        const mensaje = document.getElementById("mensaje").value;
        const password = document.getElementById("password").value;
        
        if (!mensaje) {
          alert("Por favor ingresa un mensaje");
          return;
        }
        if (!password) {
          alert("Por favor ingresa una contraseña");
          return;
        }

        const enc = new TextEncoder();
        let datos = enc.encode(mensaje);

        const salt = crypto.getRandomValues(new Uint8Array(16));
        const clave = await derivarClave(password, salt, 32);

        datos = xor(datos, clave);

        datos = sustitucion(datos, clave);

        const aes = await cifrarAES(datos, clave);
        datos = aes.datos;

        const resultado = {
          salt: arrayToBase64(salt),
          iv: arrayToBase64(aes.iv),
          datos: arrayToBase64(datos)
        };

        document.getElementById("resultado").innerText = JSON.stringify(resultado, null, 2);
      } catch (error) {
        document.getElementById("resultado").innerText = "Error al cifrar: " + error.message;
      }
    }
    async function descifrar() {
      try {
        const password = document.getElementById("passwordDescifrar").value;
        let mensajeCifrado = document.getElementById("mensajeCifrado").value.trim();
        
        if (!password) {
          alert("Por favor ingresa la contraseña");
          return;
        }
        
        if (!mensajeCifrado) {
          alert("Por favor pega el mensaje cifrado");
          return;
        }

        mensajeCifrado = mensajeCifrado.replace(/\n\s*/g, '').replace(/\s+/g, ' ').trim();
        
        const startIdx = mensajeCifrado.indexOf('{');
        const endIdx = mensajeCifrado.lastIndexOf('}');
        if (startIdx !== -1 && endIdx !== -1) {
          mensajeCifrado = mensajeCifrado.substring(startIdx, endIdx + 1);
        }

        const paquete = JSON.parse(mensajeCifrado);

        if (!paquete.salt || !paquete.iv || !paquete.datos) {
          throw new Error("El mensaje cifrado no tiene el formato correcto. Debe contener: salt, iv y datos");
        }

        const salt = base64ToArray(paquete.salt);
        const iv = base64ToArray(paquete.iv);
        const datos = base64ToArray(paquete.datos);

        const clave = await derivarClave(password, salt, 32);

        let descifrado = await descifrarAES(datos, clave, iv);

        descifrado = inversaSustitucion(descifrado, clave);

        descifrado = xor(descifrado, clave);

        const dec = new TextDecoder();
        document.getElementById("resultado").innerText = dec.decode(descifrado);
      } catch (error) {
        let errorMsg = "Error al descifrar: " + error.message;
        
        if (error.message.includes("JSON")) {
          errorMsg += "\n\n El formato del mensaje cifrado no es válido.";
          errorMsg += "\nDebe ser un JSON como: {\"salt\":\"...\",\"iv\":\"...\",\"datos\":\"...\"}";
        } else if (error.message.includes("decrypt")) {
          errorMsg = "Error al descifrar: La contraseña es incorrecta";
        }
        
        document.getElementById("resultado").innerText = errorMsg;
      }
    }
  </script>
</body>
</html>
