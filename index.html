<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cifrador</title>
  <style>
    body {  margin: 20px; background: #adcfcf; }
    h1 { text-align: center; }
    textarea { width: 100%; height: 70px; border: 1px solid #000000 }
    .output { background: #f7f7f7; padding: 30px; border: 1px solid #000000; margin-top: 10px; word-wrap: break-word}
    button { margin: 5px; padding: 10px 50px; background: #7a7272; border: 0px }
  </style>
</head>

<body>
  <h1>CIFRADOR MULTICAPA </h1>
  
  <label>Mensaje:</label><br>
  <textarea id="mensaje"></textarea><br>
  
  <label>Contraseña:</label><br>
  <input type="password" id="password"><br><br>
  
  <button onclick="cifrar()">Cifrar</button>
  
  <button onclick="descifrar()">Descifrar</button>
  
  <div class="output" id="resultado"></div>
  
  <script>
    // Función XOR simple
    function xor(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = data[i] ^ key[i % key.length];
      }
      return out;
    }

    // Sustitución polialfabética simple
    function sustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] + key[i % key.length]) % 256;
      }
      return out;
    }

    function inversaSustitucion(data, key) {
      let out = new Uint8Array(data.length);
      for (let i = 0; i < data.length; i++) {
        out[i] = (data[i] - key[i % key.length] + 256) % 256;
      }
      return out;
    }

    // Derivar clave con PBKDF2
    async function derivarClave(password, salt, length=32) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveBits"]
      );
      const bits = await crypto.subtle.deriveBits(
        {name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"},
        keyMaterial, length*8
      );
      return new Uint8Array(bits);
    }

    // AES-GCM
    async function cifrarAES(data, key) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["encrypt"]);
      const cifrado = await crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, cryptoKey, data);
      return {iv: iv, datos: new Uint8Array(cifrado)};
    }

    async function descifrarAES(datos, key, iv) {
      const cryptoKey = await crypto.subtle.importKey("raw", key, "AES-GCM", false, ["decrypt"]);
      const descifrado = await crypto.subtle.decrypt({name: "AES-GCM", iv: iv}, cryptoKey, datos);
      return new Uint8Array(descifrado);
    }

    // Función principal de cifrado
    async function cifrar() {
      const mensaje = document.getElementById("mensaje").value;
      const password = document.getElementById("password").value;
      const enc = new TextEncoder();
      let datos = enc.encode(mensaje);

      // Generar salt
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const clave = await derivarClave(password, salt, 32);

      // Capa 1: XOR
      datos = xor(datos, clave);

      // Capa 2: Sustitución
      datos = sustitucion(datos, clave);

      // Capa 3: AES-GCM
      const aes = await cifrarAES(datos, clave);
      datos = aes.datos;

      // Empaquetar
      const resultado = {
        salt: btoa(String.fromCharCode(...salt)),
        iv: btoa(String.fromCharCode(...aes.iv)),
        datos: btoa(String.fromCharCode(...datos))
      };

      document.getElementById("resultado").innerText = JSON.stringify(resultado, null, 2);
    }

    // Función principal de descifrado
    async function descifrar() {
      const password = document.getElementById("password").value;
      const paquete = JSON.parse(document.getElementById("resultado").innerText);

      const salt = Uint8Array.from(atob(paquete.salt), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(paquete.iv), c => c.charCodeAt(0));
      const datos = Uint8Array.from(atob(paquete.datos), c => c.charCodeAt(0));

      const clave = await derivarClave(password, salt, 32);

      // AES-GCM inverso
      let descifrado = await descifrarAES(datos, clave, iv);

      // Sustitución inversa
      descifrado = inversaSustitucion(descifrado, clave);

      // XOR inverso
      descifrado = xor(descifrado, clave);

      const dec = new TextDecoder();
      document.getElementById("resultado").innerText = dec.decode(descifrado);
    }
  </script>
</body>
</html>
